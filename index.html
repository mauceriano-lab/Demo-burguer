<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Demo Tienda por WhatsApp</title>
  <style>
    :root{
      --bg:#070b14;
      --panel:#0f1b33;
      --panel2:#0c162b;
      --text:#e6edf7;
      --muted:#9fb0c6;
      --border:rgba(159,176,198,.18);
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background: radial-gradient(1200px 600px at 30% -20%, rgba(34,197,94,.18), transparent 60%),
                  radial-gradient(900px 500px at 110% 20%, rgba(245,158,11,.14), transparent 55%),
                  linear-gradient(180deg, #050813, var(--bg));
      color:var(--text);
    }
    a{color:inherit}
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(5,8,19,.82);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand h1{margin:0;font-size:16px;letter-spacing:.2px}
    .brand small{color:var(--muted)}
    .chiprow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{
      display:flex; gap:10px; align-items:center;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 12px;
      background:rgba(15,27,51,.65);
      box-shadow: 0 8px 25px rgba(0,0,0,.15);
      font-size:13px;
    }
    .chip b{font-variant-numeric: tabular-nums}
    .chip .dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
    main .grid{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ main .grid{grid-template-columns:1fr} }

    .panel{
      background:rgba(15,27,51,.78);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .panel h2{
      margin:0;
      padding:12px 14px;
      font-size:14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(12,22,43,.4), rgba(12,22,43,.0));
    }
    .panel .content{padding:14px}
    .controls{
      display:grid;
      grid-template-columns: 1fr 220px;
      gap:10px;
      margin-bottom:12px;
    }
    @media (max-width: 560px){ .controls{grid-template-columns:1fr} }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(12,22,43,.55);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:70px;resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(159,176,198,.7)}
    .products{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 980px){ .products{grid-template-columns: repeat(2, minmax(0,1fr))} }
    @media (max-width: 560px){ .products{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:rgba(12,22,43,.5);
      display:flex;
      flex-direction:column;
      min-height: 100%;
    }
    .card img{
      width:100%;
      height:160px;
      object-fit:cover;
      background:#0b1220;
      display:block;
    }
    .card .meta{
      padding:10px 10px 12px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
    }
    .row{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .name{font-size:14px;margin:0}
    .badge{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
      background:rgba(15,27,51,.45);
    }
    .desc{margin:0;color:var(--muted);font-size:12px;line-height:1.35}
    .price{
      font-variant-numeric: tabular-nums;
      font-weight:700;
      font-size:14px;
    }
    .btnrow{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:auto}
    button{
      cursor:pointer;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(15,27,51,.6);
      color:var(--text);
      padding:10px 10px;
      font-weight:600;
    }
    button.primary{
      background:rgba(34,197,94,.16);
      border-color: rgba(34,197,94,.45);
    }
    button.danger{
      background:rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.45);
    }
    button:disabled{opacity:.5;cursor:not-allowed}

    .cartlist{display:flex;flex-direction:column;gap:10px}
    .cartitem{
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(12,22,43,.5);
      padding:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .thumb{
      width:56px;height:56px;border-radius:12px;object-fit:cover;background:#0b1220;
      border:1px solid rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .cartmeta{flex:1;display:flex;flex-direction:column;gap:6px}
    .cartmeta .title{margin:0;font-size:13px}
    .cartmeta .sub{color:var(--muted);font-size:12px}
    .qtyrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .qtybtn{padding:6px 10px;border-radius:10px}
    .qty{
      min-width:32px;text-align:center;font-variant-numeric: tabular-nums;
      padding:6px 10px;border-radius:10px;border:1px solid var(--border);
      background:rgba(15,27,51,.45);
    }
    .totals{
      margin-top:12px;
      border-top:1px solid var(--border);
      padding-top:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .line{display:flex;justify-content:space-between;gap:12px;color:var(--muted);font-size:13px}
    .line strong{color:var(--text)}
    .help{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .warnbox{
      border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.08);
      padding:10px;
      border-radius:14px;
      color:rgba(255,255,255,.9);
      font-size:12px;
      line-height:1.35;
    }
    .footerbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top:10px;
    }
    .smallbtn{padding:8px 10px;font-size:12px;border-radius:12px}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Demo ‚Äî Tienda por WhatsApp (Carrito + Pedido)</h1>
        <small>Selecciona productos, completa tus datos y env√≠a el pedido por WhatsApp al vendedor.</small>
      </div>
      <div class="chiprow">
        <div class="chip"><span class="dot"></span><span>Vendedor:</span> <b id="sellerPhoneLabel"></b></div>
        <div class="chip"><span>Items:</span> <b id="cartCount">0</b></div>
        <div class="chip"><span>Total:</span> <b id="cartTotal">$0</b></div>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- Cat√°logo -->
    <section class="panel">
      <h2>Cat√°logo</h2>
      <div class="content">
        <div class="controls">
          <input id="search" type="search" placeholder="Buscar por nombre o detalle (ej. 'algod√≥n', 'caf√©', 'fitness')‚Ä¶" />
          <select id="category">
            <option value="__all__">Todas las categor√≠as</option>
          </select>
        </div>

        <div id="products" class="products"></div>

        <div class="help">
          Tip: esta demo usa fotos p√∫blicas aleatorias (picsum.photos). En tu versi√≥n real, cambia la propiedad <b>image</b> de cada producto por tu URL o por <code>img/tu-foto.jpg</code>.
        </div>
      </div>
    </section>

    <!-- Carrito + Checkout -->
    <aside class="panel">
      <h2>Carrito y pedido</h2>
      <div class="content">
        <div id="cartEmpty" class="warnbox">
          Tu carrito est√° vac√≠o. Agrega productos del cat√°logo para poder enviar el pedido.
        </div>

        <div id="cart" class="cartlist" style="display:none;"></div>

        <div class="totals">
          <div class="line"><span>Subtotal</span><strong id="subtotal">$0</strong></div>
          <div class="line"><span>Env√≠o</span><strong id="shipping">$0</strong></div>
          <div class="line"><span>Total</span><strong id="total">$0</strong></div>
        </div>

        <div class="footerbar">
          <button class="smallbtn danger" id="clearCartBtn" type="button">Vaciar carrito</button>
          <span class="muted" style="font-size:12px;">Se guarda autom√°ticamente</span>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;">

        <div style="display:flex;flex-direction:column;gap:10px;">
          <input id="custName" placeholder="Tu nombre" autocomplete="name" />
          <input id="custPhone" placeholder="Tu tel√©fono (con prefijo si quieres)" autocomplete="tel" />
          <textarea id="custAddress" placeholder="Direcci√≥n completa (calle, n√∫mero, colonia, ciudad, CP)‚Ä¶" autocomplete="street-address"></textarea>
          <textarea id="custNotes" placeholder="Notas (horario, referencias, sabor, talla/color, etc.) (opcional)"></textarea>

          <button id="whatsBtn" class="primary" type="button" disabled>
            Enviar pedido por WhatsApp
          </button>

          <div class="help">
            Al enviar, se abrir√° WhatsApp con el mensaje armado. El vendedor luego te compartir√° su enlace de pago.
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div style="margin-top:14px;color:var(--muted);font-size:12px;">
    Demo educativa. No se almacenan pedidos en servidor: todo se arma en tu navegador y se env√≠a por WhatsApp.
  </div>
</main>

<script>
/** =========================
 *  Configuraci√≥n
 *  ========================= */
const SELLER_PHONE_E164 = "34633817413"; // +34 633 817 413 -> wa.me exige sin "+"
const SELLER_DISPLAY = "+34 633 817 413";

// Ajusta moneda a tu gusto: "MXN", "EUR", etc.
const CURRENCY = "EUR";

// En esta demo el env√≠o es 0 (puedes cambiarlo a n√∫mero fijo o calcularlo).
const SHIPPING_FLAT = 0;

/** =========================
 *  Cat√°logo (18 productos: 3 categor√≠as x 6)
 *  Fotos: picsum.photos (p√∫blicas)
 *  ========================= */
const PRODUCTS = [
  // --- Ropa (6) ---
  {
    id: "ropa-001",
    category: "Ropa",
    name: "Playera Premium Algod√≥n",
    price: 18.99,
    image: "https://picsum.photos/seed/playera-premium/800/520",
    description: "Algod√≥n peinado, corte unisex. Ideal para diario."
  },
  {
    id: "ropa-002",
    category: "Ropa",
    name: "Sudadera Oversize",
    price: 34.50,
    image: "https://picsum.photos/seed/sudadera-oversize/800/520",
    description: "Felpa suave, estilo urbano. Tallas S‚ÄìXL."
  },
  {
    id: "ropa-003",
    category: "Ropa",
    name: "Gorra Bordada",
    price: 14.00,
    image: "https://picsum.photos/seed/gorra-bordada/800/520",
    description: "Ajustable, bordado frontal. Unitalla."
  },
  {
    id: "ropa-004",
    category: "Ropa",
    name: "Calcetas Deportivas (Pack x3)",
    price: 9.90,
    image: "https://picsum.photos/seed/calcetas-pack3/800/520",
    description: "Transpirables, soporte en arco. 3 pares."
  },
  {
    id: "ropa-005",
    category: "Ropa",
    name: "Bolsa Tote Resistente",
    price: 12.75,
    image: "https://picsum.photos/seed/tote-resistente/800/520",
    description: "Lona gruesa, ideal para mandado o escuela."
  },
  {
    id: "ropa-006",
    category: "Ropa",
    name: "Chamarra Ligera Rompevientos",
    price: 39.99,
    image: "https://picsum.photos/seed/rompevientos/800/520",
    description: "Ligera, repelente a salpicaduras. Cierre frontal."
  },

  // --- Hogar (6) ---
  {
    id: "hogar-001",
    category: "Hogar",
    name: "Vela Arom√°tica (Vainilla)",
    price: 11.50,
    image: "https://picsum.photos/seed/vela-vainilla/800/520",
    description: "Fragancia c√°lida, 35h aprox. Envase de vidrio."
  },
  {
    id: "hogar-002",
    category: "Hogar",
    name: "Difusor de Varillas",
    price: 16.90,
    image: "https://picsum.photos/seed/difusor-varillas/800/520",
    description: "Aroma suave constante. Incluye 6 varillas."
  },
  {
    id: "hogar-003",
    category: "Hogar",
    name: "Taza Cer√°mica Minimal",
    price: 8.20,
    image: "https://picsum.photos/seed/taza-minimal/800/520",
    description: "Resistente, apta microondas. 330ml."
  },
  {
    id: "hogar-004",
    category: "Hogar",
    name: "Botella T√©rmica 500ml",
    price: 19.99,
    image: "https://picsum.photos/seed/botella-termica/800/520",
    description: "Mantiene fr√≠o/calor. Acero inoxidable."
  },
  {
    id: "hogar-005",
    category: "Hogar",
    name: "Organizador de Escritorio",
    price: 13.40,
    image: "https://picsum.photos/seed/organizador-escritorio/800/520",
    description: "Ordena plumas, notas y cables. Compacto."
  },
  {
    id: "hogar-006",
    category: "Hogar",
    name: "Set Toallas (2 piezas)",
    price: 21.00,
    image: "https://picsum.photos/seed/set-toallas/800/520",
    description: "Suaves, absorbentes. 1 grande + 1 mediana."
  },

  // --- Alimentos (6) ---
  {
    id: "food-001",
    category: "Alimentos",
    name: "Caf√© Molido Artesanal 250g",
    price: 10.90,
    image: "https://picsum.photos/seed/cafe-artesanal/800/520",
    description: "Tueste medio, notas a chocolate. 250g."
  },
  {
    id: "food-002",
    category: "Alimentos",
    name: "Granola Crujiente 400g",
    price: 7.80,
    image: "https://picsum.photos/seed/granola-crujiente/800/520",
    description: "Avena, nuez y miel. Ideal con yogurt."
  },
  {
    id: "food-003",
    category: "Alimentos",
    name: "Miel Pura 350g",
    price: 9.60,
    image: "https://picsum.photos/seed/miel-pura/800/520",
    description: "Miel 100% natural. Envasada localmente."
  },
  {
    id: "food-004",
    category: "Alimentos",
    name: "Salsa Picante (Nivel Medio)",
    price: 5.40,
    image: "https://picsum.photos/seed/salsa-picante/800/520",
    description: "Equilibrada, buen sabor. 150ml."
  },
  {
    id: "food-005",
    category: "Alimentos",
    name: "Galletas Caseras (Caja x12)",
    price: 12.00,
    image: "https://picsum.photos/seed/galletas-caseras/800/520",
    description: "Surtido. Perfectas para regalo."
  },
  {
    id: "food-006",
    category: "Alimentos",
    name: "Chocolate Amargo 70% (Barra)",
    price: 4.90,
    image: "https://picsum.photos/seed/chocolate-70/800/520",
    description: "Sabor intenso. 80g."
  },
];

/** =========================
 *  Estado + Persistencia
 *  ========================= */
const LS_KEY = "demo_whatsapp_shop_v1";
const state = loadState() || {
  cart: {}, // { productId: qty }
  customer: { name:"", phone:"", address:"", notes:"" },
  ui: { search:"", category:"__all__" }
};

function loadState(){
  try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

/** =========================
 *  Helpers
 *  ========================= */
const money = (n) =>
  new Intl.NumberFormat("es-ES", { style:"currency", currency: CURRENCY, maximumFractionDigits: 2 }).format(n);

function getProductById(id){ return PRODUCTS.find(p => p.id === id); }

function cartItems(){
  return Object.entries(state.cart)
    .map(([id, qty]) => ({ product: getProductById(id), qty: Number(qty) }))
    .filter(x => x.product && x.qty > 0);
}

function cartCount(){
  return cartItems().reduce((sum, x) => sum + x.qty, 0);
}

function subtotal(){
  return cartItems().reduce((sum, x) => sum + x.qty * x.product.price, 0);
}

/** =========================
 *  UI Elements
 *  ========================= */
const elProducts = document.getElementById("products");
const elCategory = document.getElementById("category");
const elSearch = document.getElementById("search");
const elCart = document.getElementById("cart");
const elCartEmpty = document.getElementById("cartEmpty");
const elCartCount = document.getElementById("cartCount");
const elCartTotal = document.getElementById("cartTotal");
const elSubtotal = document.getElementById("subtotal");
const elShipping = document.getElementById("shipping");
const elTotal = document.getElementById("total");
const elWhatsBtn = document.getElementById("whatsBtn");
const elClearCartBtn = document.getElementById("clearCartBtn");

const elCustName = document.getElementById("custName");
const elCustPhone = document.getElementById("custPhone");
const elCustAddress = document.getElementById("custAddress");
const elCustNotes = document.getElementById("custNotes");

document.getElementById("sellerPhoneLabel").textContent = SELLER_DISPLAY;

/** =========================
 *  Render: Category options
 *  ========================= */
function renderCategories(){
  const cats = Array.from(new Set(PRODUCTS.map(p => p.category))).sort((a,b)=>a.localeCompare(b,"es"));
  // keep first option
  const keep = elCategory.querySelector('option[value="__all__"]');
  elCategory.innerHTML = "";
  elCategory.appendChild(keep);
  cats.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c;
    elCategory.appendChild(opt);
  });

  elCategory.value = state.ui.category || "__all__";
}

/** =========================
 *  Render: Products list
 *  ========================= */
function filteredProducts(){
  const q = (state.ui.search || "").trim().toLowerCase();
  const cat = state.ui.category || "__all__";
  return PRODUCTS.filter(p => {
    const okCat = (cat === "__all__") || (p.category === cat);
    const hay = (p.name + " " + p.description + " " + p.category).toLowerCase();
    const okQ = !q || hay.includes(q);
    return okCat && okQ;
  });
}

function renderProducts(){
  const list = filteredProducts();

  elProducts.innerHTML = "";
  list.forEach(p => {
    const inCart = state.cart[p.id] || 0;

    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("img");
    img.src = p.image;
    img.alt = p.name;

    const meta = document.createElement("div");
    meta.className = "meta";

    const row1 = document.createElement("div");
    row1.className = "row";
    const h = document.createElement("p");
    h.className = "name";
    h.textContent = p.name;

    const badge = document.createElement("span");
    badge.className = "badge";
    badge.textContent = p.category;

    row1.appendChild(h);
    row1.appendChild(badge);

    const d = document.createElement("p");
    d.className = "desc";
    d.textContent = p.description;

    const row2 = document.createElement("div");
    row2.className = "row";
    const price = document.createElement("div");
    price.className = "price";
    price.textContent = money(p.price);

    const btnrow = document.createElement("div");
    btnrow.className = "btnrow";

    const add = document.createElement("button");
    add.className = "primary";
    add.type = "button";
    add.textContent = inCart ? `Agregar (+1) ¬∑ En carrito: ${inCart}` : "Agregar al carrito";
    add.onclick = () => addToCart(p.id, 1);

    const less = document.createElement("button");
    less.type = "button";
    less.textContent = "Quitar (-1)";
    less.disabled = !inCart;
    less.onclick = () => addToCart(p.id, -1);

    btnrow.appendChild(add);
    btnrow.appendChild(less);

    row2.appendChild(price);

    meta.appendChild(row1);
    meta.appendChild(d);
    meta.appendChild(row2);
    meta.appendChild(btnrow);

    card.appendChild(img);
    card.appendChild(meta);

    elProducts.appendChild(card);
  });

  if(list.length === 0){
    const empty = document.createElement("div");
    empty.className = "warnbox";
    empty.textContent = "No hay productos con ese filtro/b√∫squeda.";
    elProducts.appendChild(empty);
  }
}

/** =========================
 *  Cart operations + render
 *  ========================= */
function addToCart(productId, delta){
  const current = Number(state.cart[productId] || 0);
  const next = Math.max(0, current + delta);
  if(next === 0) delete state.cart[productId];
  else state.cart[productId] = next;

  saveState();
  renderAll();
}

function setQty(productId, qty){
  const q = Math.max(0, Number(qty || 0));
  if(q === 0) delete state.cart[productId];
  else state.cart[productId] = q;

  saveState();
  renderAll();
}

function clearCart(){
  state.cart = {};
  saveState();
  renderAll();
}

function renderCart(){
  const items = cartItems();
  const count = cartCount();
  const sub = subtotal();
  const ship = SHIPPING_FLAT;
  const tot = sub + ship;

  elCartCount.textContent = String(count);
  elCartTotal.textContent = money(tot);

  elSubtotal.textContent = money(sub);
  elShipping.textContent = money(ship);
  elTotal.textContent = money(tot);

  if(items.length === 0){
    elCart.style.display = "none";
    elCartEmpty.style.display = "block";
  } else {
    elCart.style.display = "flex";
    elCartEmpty.style.display = "none";
  }

  elCart.innerHTML = "";
  items.forEach(({product, qty}) => {
    const row = document.createElement("div");
    row.className = "cartitem";

    const img = document.createElement("img");
    img.className = "thumb";
    img.src = product.image;
    img.alt = product.name;

    const meta = document.createElement("div");
    meta.className = "cartmeta";

    const title = document.createElement("p");
    title.className = "title";
    title.textContent = product.name;

    const subline = document.createElement("div");
    subline.className = "sub";
    subline.textContent = `${product.category} ¬∑ ${money(product.price)} c/u`;

    const qtyrow = document.createElement("div");
    qtyrow.className = "qtyrow";

    const minus = document.createElement("button");
    minus.className = "qtybtn";
    minus.type = "button";
    minus.textContent = "‚àí";
    minus.onclick = () => addToCart(product.id, -1);

    const q = document.createElement("div");
    q.className = "qty";
    q.textContent = String(qty);

    const plus = document.createElement("button");
    plus.className = "qtybtn";
    plus.type = "button";
    plus.textContent = "+";
    plus.onclick = () => addToCart(product.id, 1);

    const del = document.createElement("button");
    del.className = "qtybtn danger";
    del.type = "button";
    del.textContent = "Eliminar";
    del.onclick = () => setQty(product.id, 0);

    const lineTotal = document.createElement("div");
    lineTotal.className = "sub";
    lineTotal.style.marginLeft = "auto";
    lineTotal.style.fontVariantNumeric = "tabular-nums";
    lineTotal.textContent = money(product.price * qty);

    qtyrow.appendChild(minus);
    qtyrow.appendChild(q);
    qtyrow.appendChild(plus);
    qtyrow.appendChild(del);
    qtyrow.appendChild(lineTotal);

    meta.appendChild(title);
    meta.appendChild(subline);
    meta.appendChild(qtyrow);

    row.appendChild(img);
    row.appendChild(meta);

    elCart.appendChild(row);
  });

  updateWhatsBtnState();
}

/** =========================
 *  Customer form
 *  ========================= */
function hydrateCustomer(){
  elCustName.value = state.customer.name || "";
  elCustPhone.value = state.customer.phone || "";
  elCustAddress.value = state.customer.address || "";
  elCustNotes.value = state.customer.notes || "";
}

function saveCustomerFromInputs(){
  state.customer.name = elCustName.value.trim();
  state.customer.phone = elCustPhone.value.trim();
  state.customer.address = elCustAddress.value.trim();
  state.customer.notes = elCustNotes.value.trim();
  saveState();
  updateWhatsBtnState();
}

["input","change"].forEach(evt=>{
  elCustName.addEventListener(evt, saveCustomerFromInputs);
  elCustPhone.addEventListener(evt, saveCustomerFromInputs);
  elCustAddress.addEventListener(evt, saveCustomerFromInputs);
  elCustNotes.addEventListener(evt, saveCustomerFromInputs);
});

function updateWhatsBtnState(){
  const items = cartItems();
  const hasItems = items.length > 0;
  const nameOk = (state.customer.name || "").length >= 2;
  const addrOk = (state.customer.address || "").length >= 6;
  const phoneOk = (state.customer.phone || "").length >= 6; // flexible
  elWhatsBtn.disabled = !(hasItems && nameOk && addrOk && phoneOk);
}

/** =========================
 *  WhatsApp message builder
 *  ========================= */
function buildWhatsMessage(){
  const items = cartItems();
  const sub = subtotal();
  const ship = SHIPPING_FLAT;
  const tot = sub + ship;

  const lines = [];
  lines.push("üõí *NUEVO PEDIDO*");
  lines.push("");
  lines.push(`üë§ *Nombre:* ${state.customer.name}`);
  lines.push(`üìû *Tel√©fono:* ${state.customer.phone}`);
  lines.push(`üìç *Direcci√≥n:* ${state.customer.address}`);
  if(state.customer.notes){
    lines.push(`üìù *Notas:* ${state.customer.notes}`);
  }
  lines.push("");
  lines.push("*Productos:*");

  items.forEach(({product, qty}) => {
    const line = `- ${product.name} x${qty} ‚Äî ${money(product.price * qty)}`;
    lines.push(line);
  });

  lines.push("");
  lines.push(`Subtotal: ${money(sub)}`);
  lines.push(`Env√≠o: ${money(ship)}`);
  lines.push(`*Total: ${money(tot)}*`);
  lines.push("");
  lines.push("‚úÖ Confirmo este pedido. ¬øMe compartes el enlace de pago?");
  return lines.join("\n");
}

function openWhatsApp(){
  const msg = buildWhatsMessage();
  const url = `https://wa.me/${SELLER_PHONE_E164}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank", "noopener,noreferrer");
}

/** =========================
 *  Wire up UI events
 *  ========================= */
elSearch.addEventListener("input", () => {
  state.ui.search = elSearch.value;
  saveState();
  renderProducts();
});

elCategory.addEventListener("change", () => {
  state.ui.category = elCategory.value;
  saveState();
  renderProducts();
});

elWhatsBtn.addEventListener("click", openWhatsApp);
elClearCartBtn.addEventListener("click", clearCart);

/** =========================
 *  Initial render
 *  ========================= */
function renderAll(){
  // Restore filters
  elSearch.value = state.ui.search || "";
  elCategory.value = state.ui.category || "__all__";

  renderProducts();
  renderCart();
}

renderCategories();
hydrateCustomer();
renderAll();
</script>
</body>
</html>
