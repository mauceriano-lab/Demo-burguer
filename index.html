<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PideLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --btn:#000000; --txt:#000000; --bg:#f9fafb; }
    body { background-color: var(--bg); color: var(--txt); font-family: system-ui, -apple-system, sans-serif; }
    .btn-principal { background-color: var(--btn) !important; color: white; }
    .modal-animate { animation: slideUp .3s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .qtybox { width: 132px; } /* ancho fijo para no mover nada en la barra inferior del modal */
  </style>
</head>

<body class="pb-20">

<header class="bg-white sticky top-0 z-40 border-b shadow-sm">
  <div class="max-w-md mx-auto px-5 py-4 flex justify-between items-center">
    <h1 id="store-title" class="text-xl font-black italic tracking-tighter uppercase">PIDELINK</h1>
    <button onclick="toggleCart()" class="relative p-2 bg-gray-100 rounded-full">
      <i class="fa-solid fa-shopping-bag text-xl"></i>
      <span id="cart-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
    </button>
  </div>

  <div id="cats-bar" class="max-w-md mx-auto px-5 py-3 flex gap-2 overflow-x-auto no-scrollbar border-t bg-white">
    <!-- categor√≠as din√°micas -->
  </div>
</header>

<main class="max-w-md mx-auto px-5 py-6">
  <div class="mb-4 relative">
    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
    <input id="search" oninput="applySearch()" placeholder="Buscar productos..."
           class="w-full pl-9 pr-3 py-3 bg-white border rounded-2xl text-sm font-semibold shadow-sm">
  </div>

  <div id="product-grid" class="grid grid-cols-2 gap-4"></div>

  <div id="load-error" class="hidden mt-4 bg-white border rounded-2xl p-4 text-sm font-bold text-red-600">
    No se pudo cargar el cat√°logo desde Google Sheets. Revisa:
    <ul class="list-disc pl-5 mt-2 text-red-600 font-semibold">
      <li>Que el Sheet est√© ‚ÄúPublicado en la web‚Äù.</li>
      <li>Que el SHEET_ID sea correcto.</li>
      <li>Que las hojas se llamen EXACTO: <span class="font-black">Config</span> y <span class="font-black">Products</span>.</li>
    </ul>
  </div>
</main>

<!-- Product modal -->
<div id="product-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
  <div class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-6 max-h-[90vh] overflow-y-auto modal-animate">
    <div class="flex justify-between items-center mb-4">
      <h3 id="modal-p-nombre" class="text-xl font-black uppercase"></h3>
      <button onclick="closeProductModal()" class="text-3xl text-gray-300">&times;</button>
    </div>

    <img id="modal-p-img" src="" class="w-full aspect-square object-cover rounded-[2rem] mb-4 shadow-md">
    <p id="modal-p-desc" class="text-gray-500 text-sm mb-6"></p>

    <div id="variantes-container" class="space-y-6 mb-8"></div>

    <!-- Barra inferior: Precio + Cantidad + Bot√≥n -->
    <div class="flex items-center justify-between gap-3 sticky bottom-0 bg-white pt-3 border-t">
      <span id="modal-p-precio" class="text-2xl font-black shrink-0"></span>

      <div class="qtybox shrink-0">
        <div class="flex items-center justify-between gap-2 border rounded-2xl px-2 py-2 bg-gray-50">
          <button type="button" onclick="decModalQty()"
                  class="w-10 h-10 rounded-xl border bg-white font-black flex items-center justify-center">‚àí</button>
          <span id="modal-qty" class="w-10 text-center font-black text-sm">1</span>
          <button type="button" onclick="incModalQty()"
                  class="w-10 h-10 rounded-xl border bg-white font-black flex items-center justify-center">+</button>
        </div>
      </div>

      <button id="add-from-modal" class="flex-grow btn-principal py-4 rounded-2xl font-bold uppercase text-xs tracking-widest">
        A√±adir
      </button>
    </div>
  </div>
</div>

<!-- Cart modal -->
<div id="cart-modal" class="fixed inset-0 bg-black/50 z-[70] hidden backdrop-blur-sm">
  <div class="bg-white w-full max-w-sm h-full ml-auto flex flex-col p-6 shadow-2xl overflow-y-auto">
    <div class="flex justify-between items-center border-b pb-4 mb-4">
      <h2 class="text-xl font-black uppercase">Tu Carrito</h2>
      <button onclick="toggleCart()" class="text-3xl text-gray-300">&times;</button>
    </div>

    <div id="cart-items" class="space-y-3 mb-6"></div>

    <!-- Solo datos del cliente -->
    <div class="space-y-4 border-t pt-4">
      <textarea id="cust-notes" placeholder="Notas (talla, color, referencias...)" class="w-full p-3 bg-gray-50 border rounded-xl text-sm h-16" oninput="saveState()"></textarea>
      <input type="text" id="cust-name" placeholder="Tu Nombre" class="w-full p-3 bg-gray-50 border rounded-xl text-sm" oninput="saveState()">
      <input type="tel" id="cust-phone" placeholder="Tu Tel√©fono" class="w-full p-3 bg-gray-50 border rounded-xl text-sm" oninput="saveState()">
      <input type="text" id="cust-address" placeholder="Direcci√≥n completa" class="w-full p-3 bg-gray-50 border rounded-xl text-sm" oninput="saveState()">

      <div class="flex justify-between text-2xl font-black pt-2">
        <span>TOTAL:</span>
        <span id="total-val">0</span>
      </div>

      <div class="flex gap-2">
        <button onclick="vaciarCarrito()" class="w-full py-4 rounded-2xl font-black text-xs uppercase border bg-gray-50">
          Vaciar
        </button>
        <button onclick="enviarPedido()" class="w-full btn-principal py-4 rounded-2xl font-black text-xs uppercase flex items-center justify-center gap-2">
          <i class="fa-brands fa-whatsapp text-xl"></i> Enviar pedido
        </button>
      </div>

      <p class="text-[11px] text-gray-500 font-semibold mt-1">
        El pedido se env√≠a por WhatsApp y el vendedor te comparte el enlace de pago.
      </p>
    </div>
  </div>
</div>

<script>
/** =========================
 *  1) CONECTA TU GOOGLE SHEET
 *  =========================
 * Pega aqu√≠ el ID del Sheet:
 * https://docs.google.com/spreadsheets/d/ESTE_ID/edit#gid=0
 */
const SHEET_ID = "PON_AQUI_TU_SHEET_ID";

/** Hojas (deben llamarse EXACTO as√≠) */
const SHEET_CONFIG = "Config";
const SHEET_PRODUCTS = "Products";

/** Persistencia */
const LS_KEY = "pidelink_store_v1";

/** Estado */
let CONFIG = {
  store_name: "PideLink",
  currency_code: "MXN",
  whatsapp_phone_e164: "5210000000000",
  theme_button_color: "#000000",
  theme_bg: "#f9fafb",
  theme_text: "#000000"
};

let PRODUCTOS = [];   // cargados desde Sheets
let carrito = [];     // [{k,id,n,p,o,qty}]
let seleccionActual = {};
let categoriaActual = "";
let busqueda = "";
let modalQty = 1;
let modalProducto = null;

/** Utils */
function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeAttr(s){ return escapeHtml(s).replace(/`/g,'&#96;'); }
function keyOf(id, o){
  const opts = Object.entries(o||{}).sort(([a],[b]) => a.localeCompare(b));
  return id + "||" + JSON.stringify(opts);
}
function fmtMoney(n){
  const code = CONFIG.currency_code || "MXN";
  try{
    return new Intl.NumberFormat("es-MX", { style:"currency", currency: code }).format(Number(n)||0);
  }catch(e){
    return "$" + (Number(n)||0).toFixed(2);
  }
}

/** Google Sheets fetch via gviz */
async function fetchSheetRows(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error("Fetch failed: " + sheetName);
  const txt = await res.text();
  const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1));
  const table = json.table;
  const headers = table.cols.map(c => (c.label || "").trim());
  const rows = (table.rows || []).map(r => (r.c || []).map(x => x ? (x.v ?? "") : ""));
  return { headers, rows };
}

async function loadFromSheets(){
  const errBox = document.getElementById("load-error");
  errBox.classList.add("hidden");

  // Config
  const cfg = await fetchSheetRows(SHEET_CONFIG);
  // Espera columnas: key, value
  const keyIdx = cfg.headers.findIndex(h => h.toLowerCase() === "key");
  const valIdx = cfg.headers.findIndex(h => h.toLowerCase() === "value");
  cfg.rows.forEach(r => {
    const k = String(r[keyIdx] ?? "").trim();
    const v = String(r[valIdx] ?? "").trim();
    if(k) CONFIG[k] = v;
  });

  // Theme
  document.documentElement.style.setProperty("--btn", CONFIG.theme_button_color || "#000000");
  document.documentElement.style.setProperty("--bg",  CONFIG.theme_bg || "#f9fafb");
  document.documentElement.style.setProperty("--txt", CONFIG.theme_text || "#000000");

  document.getElementById("store-title").innerText = (CONFIG.store_name || "PideLink").toUpperCase();

  // Products
  const prod = await fetchSheetRows(SHEET_PRODUCTS);
  const idx = {};
  prod.headers.forEach((h,i)=> idx[h.trim()] = i);

  PRODUCTOS = prod.rows
    .map(r => ({
      id: String(r[idx["id"]] ?? "").trim(),
      cat: String(r[idx["category"]] ?? "").trim(),
      nombre: String(r[idx["name"]] ?? "").trim(),
      precio: Number(r[idx["price"]] ?? 0),
      desc: String(r[idx["description"]] ?? "").trim(),
      img: String(r[idx["image_url"]] ?? "").trim(),
      Talla: String(r[idx["variants_Talla"]] ?? "").trim(),
      Color: String(r[idx["variants_Color"]] ?? "").trim(),
      Material: String(r[idx["variants_Material"]] ?? "").trim(),
      Sabor: String(r[idx["variants_Sabor"]] ?? "").trim(),
      Modelo: String(r[idx["variants_Modelo"]] ?? "").trim(),
      Tipo: String(r[idx["variants_Tipo"]] ?? "").trim(),
      active: String(r[idx["active"]] ?? "TRUE").trim().toUpperCase() !== "FALSE",
    }))
    .filter(p => p.id && p.cat && p.nombre && p.active);

  if(PRODUCTOS.length === 0) throw new Error("No products");

  // categor√≠as din√°micas
  const cats = [...new Set(PRODUCTOS.map(p=>p.cat))];
  categoriaActual = categoriaActual || cats[0];
  buildCatsBar(cats);

  renderGrid();
  updateCart();
}

function buildCatsBar(cats){
  const bar = document.getElementById("cats-bar");
  bar.innerHTML = cats.map((c,i) => `
    <button onclick="filterCat('${escapeAttr(c)}')" class="cat-btn ${c===categoriaActual ? "bg-black text-white" : "bg-gray-100 text-black"} px-5 py-2 rounded-full text-xs font-bold shrink-0">
      ${escapeHtml(c)}
    </button>
  `).join("");
}

function setActiveCatBtn(cat){
  document.querySelectorAll('.cat-btn').forEach(b => {
    b.classList.remove('bg-black','text-white');
    b.classList.add('bg-gray-100','text-black');
    if(b.innerText === cat){
      b.classList.add('bg-black','text-white');
      b.classList.remove('bg-gray-100');
    }
  });
}

/** Search */
function applySearch(){
  busqueda = (document.getElementById("search").value || "").trim().toLowerCase();
  saveState();
  renderGrid();
}

/** Grid */
function filterCat(cat){
  categoriaActual = cat;
  setActiveCatBtn(cat);
  saveState();
  renderGrid();
}

function renderGrid(){
  const grid = document.getElementById('product-grid');
  const list = PRODUCTOS
    .filter(p => p.cat === categoriaActual)
    .filter(p => {
      if(!busqueda) return true;
      const hay = (p.nombre + " " + p.desc + " " + JSON.stringify(p)).toLowerCase();
      return hay.includes(busqueda);
    });

  grid.innerHTML = list.map(p => `
    <div onclick="openModal('${escapeAttr(p.id)}')" class="bg-white rounded-[2rem] p-3 border border-gray-100 flex flex-col shadow-sm cursor-pointer active:scale-95 transition-all">
      <img src="${p.img}" class="w-full aspect-square object-cover rounded-[1.5rem] mb-2"
           onerror="this.src='https://picsum.photos/seed/${encodeURIComponent(p.nombre)}/600/600'">
      <h3 class="text-xs font-black uppercase tracking-tighter">${escapeHtml(p.nombre)}</h3>
      <p class="font-bold text-sm mt-1 text-black">${escapeHtml(fmtMoney(p.precio))}</p>
    </div>
  `).join('') || `<div class="col-span-2 text-sm font-bold text-gray-500 bg-white border rounded-2xl p-4">No hay resultados.</div>`;
}

/** Modal qty */
function syncModalQty(){ document.getElementById('modal-qty').innerText = String(modalQty); }
function incModalQty(){ modalQty += 1; syncModalQty(); }
function decModalQty(){ modalQty = Math.max(1, modalQty - 1); syncModalQty(); }

/** Modal */
function openModal(id){
  const p = PRODUCTOS.find(x => x.id === id);
  if(!p) return;
  modalProducto = p;
  seleccionActual = {};
  modalQty = 1; syncModalQty();

  document.getElementById('modal-p-nombre').innerText = p.nombre;
  document.getElementById('modal-p-img').src = p.img;
  document.getElementById('modal-p-desc').innerText = p.desc;
  document.getElementById('modal-p-precio').innerText = fmtMoney(p.precio);

  const cont = document.getElementById('variantes-container');
  cont.innerHTML = "";

  ['Talla', 'Color', 'Material', 'Sabor', 'Modelo', 'Tipo'].forEach(key => {
    if(p[key]) {
      const opciones = String(p[key]).split(',').map(o => o.trim()).filter(Boolean);
      cont.innerHTML += `
        <div>
          <label class="text-[10px] font-bold text-gray-400 block mb-2 uppercase">${escapeHtml(key)}</label>
          <div class="flex gap-2 flex-wrap" id="g-${key}">
            ${opciones.map(o => `
              <button type="button" onclick="sel(this, '${key}', '${escapeAttr(o)}')" class="border-2 px-4 py-2 rounded-xl text-xs font-bold">
                ${escapeHtml(o)}
              </button>
            `).join('')}
          </div>
        </div>
      `;
    }
  });

  document.getElementById('add-from-modal').onclick = () => {
    addToCart(p.id, p.nombre, p.precio, {...seleccionActual}, modalQty);
    closeProductModal();
  };

  document.getElementById('product-modal').classList.remove('hidden');
}

function sel(btn, k, v){
  document.querySelectorAll(`#g-${k} button`).forEach(b => b.classList.remove('bg-black', 'text-white', 'border-black'));
  btn.classList.add('bg-black', 'text-white', 'border-black');
  seleccionActual[k] = v;
}

function closeProductModal(){ document.getElementById('product-modal').classList.add('hidden'); }
function toggleCart(){ document.getElementById('cart-modal').classList.toggle('hidden'); }

/** Cart */
function addToCart(id, n, p, o, qty){
  const k = keyOf(id, o);
  const found = carrito.find(x => x.k === k);
  if(found) found.qty += qty;
  else carrito.push({ k, id, n, p, o, qty });
  saveState();
  updateCart();
}

function incItem(k){
  const it = carrito.find(x => x.k === k); if(!it) return;
  it.qty += 1; saveState(); updateCart();
}
function decItem(k){
  const it = carrito.find(x => x.k === k); if(!it) return;
  it.qty -= 1;
  if(it.qty <= 0) carrito = carrito.filter(x => x.k !== k);
  saveState(); updateCart();
}
function removeItem(k){ carrito = carrito.filter(x => x.k !== k); saveState(); updateCart(); }
function vaciarCarrito(){ if(!confirm("¬øVaciar carrito?")) return; carrito = []; saveState(); updateCart(); }

function updateCart(){
  const count = carrito.reduce((s,x)=>s+x.qty,0);
  document.getElementById('cart-count').innerText = count;

  let total = 0;
  document.getElementById('cart-items').innerHTML = carrito.map(it => {
    const variantes = Object.values(it.o||{}).join(' / ') || 'Sin variantes';
    const lineTotal = (Number(it.p)||0) * (Number(it.qty)||0);
    total += lineTotal;

    return `
      <div class="bg-gray-50 p-3 rounded-2xl text-xs font-bold">
        <div class="flex justify-between gap-3">
          <div>
            <span>${escapeHtml(it.n)}</span><br>
            <small class="text-gray-400">${escapeHtml(variantes)}</small>
          </div>
          <div class="text-right whitespace-nowrap">
            <div>${escapeHtml(fmtMoney(lineTotal))}</div>
            <div class="text-[10px] text-gray-400 font-black">${escapeHtml(fmtMoney(it.p))} c/u</div>
          </div>
        </div>

        <div class="mt-3 flex items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <button type="button" onclick="decItem('${escapeAttr(it.k)}')" class="px-3 py-2 rounded-xl border bg-white font-black">‚àí</button>
            <span class="px-3 py-2 rounded-xl border bg-white font-black">${it.qty}</span>
            <button type="button" onclick="incItem('${escapeAttr(it.k)}')" class="px-3 py-2 rounded-xl border bg-white font-black">+</button>
          </div>
          <button type="button" onclick="removeItem('${escapeAttr(it.k)}')" class="px-3 py-2 rounded-xl border bg-white font-black text-red-600">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>
    `;
  }).join('') || `
    <div class="bg-gray-50 p-4 rounded-2xl text-sm font-bold text-gray-500">
      Tu carrito est√° vac√≠o. Agrega productos para poder enviar el pedido.
    </div>
  `;

  document.getElementById('total-val').innerText = fmtMoney(total);
}

/** WhatsApp */
function enviarPedido(){
  const nombre = (document.getElementById('cust-name').value || "").trim();
  const tlf = (document.getElementById('cust-phone').value || "").trim();
  const addr = (document.getElementById('cust-address').value || "").trim();
  const notas = (document.getElementById('cust-notes').value || "").trim();

  if(carrito.length === 0) return alert("Tu carrito est√° vac√≠o.");
  if(!nombre || nombre.length < 2) return alert("Escribe tu nombre.");
  if(!tlf || tlf.length < 6) return alert("Escribe tu tel√©fono.");
  if(!addr || addr.length < 6) return alert("Escribe tu direcci√≥n completa.");

  const phone = String(CONFIG.whatsapp_phone_e164 || "").trim();
  if(!/^\d{8,15}$/.test(phone)) return alert("Config inv√°lida: whatsapp_phone_e164 debe ser n√∫meros sin + (E.164).");

  let lista = "";
  let total = 0;
  carrito.forEach(it => {
    const variantes = Object.values(it.o||{}).join(' / ') || "Sin variantes";
    const lineTotal = (Number(it.p)||0) * (Number(it.qty)||0);
    total += lineTotal;
    lista += `‚Ä¢ ${it.n} x${it.qty} [${variantes}] (${fmtMoney(lineTotal)})\n`;
  });

  const msg =
`üì¶ NUEVO PEDIDO
üè™ TIENDA: ${CONFIG.store_name || "PideLink"}
üë§ CLIENTE: ${nombre}
üìû TEL√âFONO: ${tlf}
üìç DIRECCI√ìN: ${addr}
------------------
üõçÔ∏è PEDIDO:
${lista}
üìù NOTAS: ${notas || "Ninguna"}
üí∞ TOTAL: ${fmtMoney(total)}
------------------
‚úÖ Confirma recepci√≥n y env√≠a enlace de pago.`;

  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, "_blank", "noopener,noreferrer");
}

/** Persistence */
function saveState(){
  const payload = {
    carrito,
    ui: { categoriaActual, busqueda },
    form: {
      notes: document.getElementById('cust-notes').value,
      name: document.getElementById('cust-name').value,
      phone: document.getElementById('cust-phone').value,
      address: document.getElementById('cust-address').value
    }
  };
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
}
function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_KEY));
    if(s?.carrito) carrito = s.carrito;
    if(s?.ui){
      categoriaActual = s.ui.categoriaActual || categoriaActual;
      busqueda = s.ui.busqueda || "";
      document.getElementById("search").value = busqueda;
    }
    if(s?.form){
      document.getElementById('cust-notes').value = s.form.notes || "";
      document.getElementById('cust-name').value = s.form.name || "";
      document.getElementById('cust-phone').value = s.form.phone || "";
      document.getElementById('cust-address').value = s.form.address || "";
    }
  }catch(e){}
}

/** Init */
(async function init(){
  loadState();
  try{
    await loadFromSheets();
  }catch(e){
    console.error(e);
    document.getElementById("load-error").classList.remove("hidden");
  }
})();
</script>

</body>
</html>
